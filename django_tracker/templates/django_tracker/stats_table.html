{% extends 'django_tracker_base.html' %}
{% load staticfiles %}
{% load django_tracker_tags %}

{% block extra_css %}
    <link rel="stylesheet" type="text/css" href="{% static 'django_tracker/django_tracker.css' %}">

    <style>
        #id_tracker_table{font-size: smaller; table-layout: fixed; width: 100%}
        #id_tracker_table td{word-break: break-all;}

        th.datetime{width:180px;}
        .url_col{width: 300px;}
        .ip_col{width: 120px;}


    </style>
{% endblock extra_css %}

{% block content %}
    <div class="container">
        <h1>Tracker Stats</h1>
        {% include 'django_tracker/selector_include.html' %}
        <a href="{{ as_histogram_url }}">as histogram</a>

        <table id="id_tracker_table">
            <thead>
                <tr>
                    <th class="datetime">Datetime</th>
                    <th class="url_col">URL</th>
                    <th>User</th>
                    <th class="ip_col">IP Address</th>
                    {% if geo_locate %}
                        <th>Location</th>
                    {% endif %}
                </tr>
            </thead>

            <tbody>
                {% for row in data %}
                    <tr>
                        <td>{{ row.datetime }}</td>
                        <td class="url_col">{{ row.url }}</td>
                        <td>{{ row.email }}</td>
                        <td>
                            {% if geo_locate %}
                                <a onclick="get_details('{{ row.ip }}')">{{ row.ip }}</a>
                            {% else %}
                                {{ row.ip }}
                            {% endif %}
                        </td>

                        {% if geo_locate %}
                            <td>{% geo_locate row.ip %}</td>
                        {% endif %}
                    </tr>
                    {% empty %}
                    <tr>
                        {% if geo_locate %}
                            <td colspan="5">No data</td>
                        {% else %}
                            <td colspan="4">No data</td>
                        {% endif %}
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <script>
        var get_details = function(ip){
            var http = new XMLHttpRequest();

            http.open("POST", "{% url 'django_tracker:get_ip_details' %}", true);
            http.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
            http.onreadystatechange = function() {//Call a function when the state changes.
                if(http.readyState == 4 && http.status == 200) {
                    var data = JSON.parse(http.responseText);
                    alert(data.details);
                }
            }
            http.send("ip=" + ip);
        }
    </script>
{% endblock content %}